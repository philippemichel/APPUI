---
title: "Rapport statistique V0.3"
cache: false
---


```{r}
#| label: setup

rm(list = ls())
#
library(ggcorrplot)
library(baseph)
# library(emmeans)
library(ggsci)
# library(plotly)
library(janitor)
library(tidyverse)
library(missMDA)
library(FactoMineR)
library(factoextra)
library(visdat)
library(kableExtra)
library(gtsummary)
library(forestmodel)
library(labelled)
#
classeur <- "appui.ods"
expx <- FALSE
if (expx) {
  file.create(classeur)
  file.remove(classeur)
  write_ods(iris, classeur)
}

# sessionInfo()
theme_gtsummary_language(language = "fr", decimal.mark = ",")
#theme_gtsummary_journal(journal = "jama")
options(OutDec = ",")
ptest <- list(all_continuous() ~ "t.test", all_categorical() ~ "chisq.test")
stt <- list(
  all_continuous() ~ "{mean} ({sd})",
  all_categorical() ~ "{n} ({p}%)"
)
load("datas/appui.RData")
#
oo <- "Oui"
ouinon <- list(
  antecedent_urinaire = oo,
  immunodepression = oo,
  exam_comp = oo,
  grossesse = oo,
  exam_com_sortie = oo,
  avis_specialise = oo,
  microbio_dispo = oo,
  germe_identifie = oo,
  insuffisance_renale = oo,
  allergie = oo
)
```

```{r}
#| label: macro_transang

aftrans <- function(x) {
  zz <- table(x)
  trans <- transangph(zz[2], sum(zz))
  pct <- paste0(zz[[2]], " cas soit ", trans$nb)
  return(pct)
}
```


# Qualité des données

## Corrélations anormales

```{r}
#| label: fig-corr
#| fig-cap: Corrélations internes
#| eval: true
zz <- tt |>
  dplyr::select(!id) |>
  dplyr::select(!starts_with("si_")) |>
  mutate_if(is.factor, as.numeric) |>
  
  remove_constant()
zzf <- cor(zz, use = "pairwise.complete.obs")
ggcorrplot(zzf,
  type = "lower",
  method = "square",
  ggtheme = "theme_light") +
  labs(title = "Corrélations",
      subtitle = "",
      x = "",
      y = "",
      caption = "",
      fill = "") +
  theme_light() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_text(size = 12),
    legend.title = element_text(size = 12),
    axis.title.y = element_text(
      size = 12,
      angle = 90,
      vjust = .5
    ),
  axis.text.x = element_text(
      angle = 90,
      vjust = .5,
      size = 5),
  axis.text.y = element_text(size = 5),
  legend.position = "right"
  )
```

On ne met pas en évidence de corrélation anormale ou gênante. 

## Données manquantes

```{r}
#| label: fig-manq
#| fig-cap: Données manquantes

tt |>
  dplyr::select(-c(id)) |>
  vis_dat(palette = "qual")
```

L'item `Fragilité` est très peu rempli ainsi que dans une moindre mesure `allergie`. les autres items comportant de nombreuses données manquantes sont celles commençant par `si\dots` ce qui est normal.

# Descriptif

::: {.callout-note}
Dans tous les tableaux, pour les variables en `Oui/Non` seules les réponses `Oui` sont affichées.
:::


Les données concernent `r nrow(tt)` cas & pour `r ncol(tt)` variables.

La $PA_{m}$ a été approchée selon l'approximation usuelle :

$$PA_{\text{Moyenne}} = \frac{PA_{\text{Systolique}} + 2 PA_{\text{Diastolique}}}{3}$$. 

```{r}
#| label: tbl-demog
#| tbl-cap: Description de la population

tt |>
  dplyr::select(sexe:allergie) |>
  tbl_summary(
    missing = "no",
    statistic = stt,
    value = ouinon
  ) |>
      add_stat_label(
    location = "column"
  ) |>
  add_n() |>
  add_ci() |>
  bold_labels() |>
  modify_header(label ~ " ") |>
  pexptabph(exp = expx, nomfich = classeur, nomsheet = "demog", lg = TRUE)
```

```{r}
#| label: fig-pyr
#| fig-cap: Pyramide des âges

pca <- c(seq(100, 0, -20), seq(20, 100, 20))
tt |>
  apyramid::age_pyramid(age, sexe,
    na.rm = TRUE,
    proportion = TRUE,
    pal = c("lightpink", "lightblue"),
    show_midpoint = FALSE
  ) +
  labs(
    title = "Pyramide des âges",
    x = "Âge"
  ) +
  theme_light() +
  scale_y_continuous(
    breaks = seq(-1, 1, .2),
    labels = paste0(pca, " %")
  ) +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_blank(),
    legend.title = element_text(size = 12),
    axis.title.y = element_text(
      size = 12,
      angle = 0,
      vjust = .5
    ),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    legend.position = "right"
  ) +
  scale_colour_manual(labels = c("lightpink", "lightblue"))
```


```{r}
#| label: constants
#| eval: false

tt <- tt |>
  janitor::remove_constant(na.rm = TRUE)

# Les variables constantes sont supprimées dans le reste du travail qui portera donc sur`r ncol(tt)` variables.
```



# Critère principal
*La proportion de patients ayant eu une prise en charge adéquate à la sortie des Urgences conformément aux recommandations de la SPILF 2018.*
```{r}
#| label: tbl-crit1
#| tbl-cap: Critère principal

tt |>
  dplyr::select(pac_recos) |>
  tbl_summary(
    missing = "no",
  ) |>
  add_n() |>
  add_ci() |>
  bold_labels() |>
  modify_header(label ~ " ") |>
  pexptabph(exp = expx, nomfich = classeur, nomsheet = "crit1", lg = TRUE)
```

Les cas conformes représentent `r aftrans(tt$pac_recos)` (Pourcentage avec son intervalle de confiance à 95 %)

## Facteurs associés

```{r}
#| label: tbl-critfact1
#| tbl-cap: Facteurs associés - analyse monovariée


tt |>
  dplyr::select(pac_recos, sexe:fc) |>
  tbl_summary(
    by = pac_recos,
    missing = "no",
    value = ouinon,
    percent = "row"
  ) |>
  modify_spanning_header(c("stat_1", "stat_2") ~ "**Conforme aux aux recommandations de la SPILF**") |> 
  add_n() |>
  add_p(test = ptest) |>
    add_stat_label(
    location = "column"
  ) |> 
  bold_labels() |>
  bold_p() |>
  modify_header(label ~ " ") |>
  separate_p_footnotes() |> 
  gexptabph(exp = expx, nomfich = classeur, nomsheet = "critfact1")
```


```{r}
#| label: tbl-princmulti
#| fig-cap: Facteurs associés - analyse multivariée


glm(pac_recos ~ sexe + age + fc +immunodepression , data = tt, family = "binomial") |> 
tbl_regression(exponentiate = TRUE) |> 
    bold_labels() |>
  bold_p() |>
  modify_header(label ~ " ") |>
  gexptabph(exp = expx, nomfich = classeur, nomsheet = "critfactmulti")
```

L'analyse en régression confirme que la prise en charge des patients de plus de 75 ans est environ quatre fois moins souvent conforme aux recommandations que pour les patients plus jeunes. Les antécédents urinaires et l'immunodépression ne peuvent être analysés faute de cas positifs.

# Objectif secondaires

## Objectif I
*Adéquation entre le diagnostic retenu, selon la symptomatologie décrite dans le dossier médical, et les définitions cliniques de la SPILF 2018.*

```{r}
#| label: tbl-crits1
#| tbl-cap: Adéquation diagnostique

tt |>
  dplyr::select(conforme_spilf) |>
  tbl_summary(
    missing = "no",
  ) |>
  add_n() |>
      add_stat_label(
    location = "column"
  ) |>
  bold_labels() |>
  add_ci() |>
  modify_header(label ~ " ") |>
  pexptabph(exp = expx, nomfich = classeur, nomsheet = "crit1", lg = TRUE)
```

Les diagnostics conformes aux recommandations de la \textsc{spif} représentent `r aftrans(tt$conforme_spilf)` (Pourcentage avec son intervalle de confiance à 95 %)

```{r}
#| label: fig-second1
#| fig-cap: Facteurs associés - analyse multivariée


ll <- glm(conforme_spilf ~ sexe + age + ta + fc, data = tt, family = "binomial")
#  forest_model()
```

## Objectif II
*Identifier les examens complémentaires demandés aux urgences pour les patients ambulatoires avec diagnostic d’infection urinaire retenu aux urgences et évaluer leur pertinence selon les recommandations de la SPILF 2018.*

### Examens demandés aux urgences

```{r}
#| label: tbl-examcomp1
#| tbl-cap: Examens complémentaires

tt |>
  dplyr::select(exam_comp:exam_dimagerie) |>
  tbl_summary(
    missing = "no",
    statistic = stt,
    value = ouinon
  ) |>
  add_n() |>
      add_stat_label(
    location = "column"
  ) |>
  bold_labels() |>
  modify_header(label ~ " ") |>
  pexptabph(exp = expx, nomfich = classeur, nomsheet = "examcomp1", lg = TRUE)
```

### Pertinence des examens demandés

```{r}
#| label: tbl-examcomp2
#| tbl-cap: Pertinence des examens demandés aux urgences

tt |>
  dplyr::select(pertinence_exam_comp) |>
  tbl_summary(
    missing = "no",
  ) |>
  add_n() |>
      add_stat_label(
    location = "column"
  ) |>
  add_ci() |>
  bold_labels() |>
  modify_header(label ~ " ") |>
  pexptabph(exp = expx, nomfich = classeur, nomsheet = "examcomp2", lg = TRUE)
```

Les demandes d'examens complémentaires conformes aux recommandations de la \textsc{spif} représentent `r aftrans(tt$pertinence_exam_comp)` (Pourcentage avec son intervalle de confiance à 95 %).

## Objectif III
*Identifier les examens complémentaires prescrits à la sortie des urgences pour les patients ambulatoires avec diagnostic d’infection urinaire retenu aux urgences et évaluer leur pertinence selon les recommandations de la spif 2018.*

### Examens demandés aux à la sortie des urgences

```{r}
#| label: tbl-examcomps1
#| tbl-cap: Examens complémentaires demandés à la sortie des urgences

tt |>
  dplyr::select(exam_com_sortie:imagerie) |>
  tbl_summary(
    missing = "no",
    statistic = stt,
    value = ouinon
  ) |>
  add_n() |>
      add_stat_label(
    location = "column"
  ) |>
  bold_labels() |>
  modify_header(label ~ " ") |>
  pexptabph(exp = expx, nomfich = classeur, nomsheet = "examcomps1", lg = TRUE)

# Attention ! Si autre à vérifier
```

### Pertinence des examens demandés à la sortie

```{r}
#| label: tbl-examcomps2
#| tbl-cap: Pertinence des examens demandés aux urgences

tt |>
  dplyr::select(pertinence_exam_sortie) |>
  tbl_summary(
    missing = "no",
  ) |>
  add_ci() |>
  add_n() |>
      add_stat_label(
    location = "column"
  ) |>
  bold_labels() |>
  modify_header(label ~ " ") |>
  pexptabph(exp = expx, nomfich = classeur, nomsheet = "examcomps2", lg = TRUE)
```

## Objectif IV
*Identifier les types de spécialistes médicaux impliqués par demande d’avis spécialisé de l’urgentiste dans la prise en charge du patient aux urgences pour suspicion d’infection urinaire.*


```{r}
#| label: tbl-spe1
#| tbl-cap: Avis spécialistes

tt |>
  dplyr::select(avis_specialise:specialite) |>
  tbl_summary(
    missing = "no",
    statistic = stt,
    value = ouinon
  ) |>
  add_n() |>
      add_stat_label(
    location = "column"
  ) |>
  bold_labels() |>
  modify_header(label ~ " ") |>
  pexptabph(exp = expx, nomfich = classeur, nomsheet = "spe1", lg = TRUE)
```

Les demandes d'avis spécialisés représentent `r aftrans(tt$pertinence_exam_comp)` (Pourcentage avec son intervalle de confiance à 95 %).

## Objectif V
*Recueillir les résultats des examens microbiologiques éventuellement demandés aux urgences et évaluer l’efficacité de la prise en charge thérapeutique proposé par l’urgentiste.*

### Microbiologie

```{r}
#| label: tbl-microb
#| tbl-cap: Microbiologie


tt |>
  dplyr::select(microbio_dispo:germe) |>
  tbl_summary(
    missing = "no",
    statistic = stt,
    value = ouinon
  ) |>
  add_n() |>
      add_stat_label(
    location = "column"
  ) |>
  bold_labels() |>
  modify_header(label ~ " ") |>
  pexptabph(exp = expx, nomfich = classeur, nomsheet = "spe1", lg = TRUE)
```

```{r}
#| label: fig-microb
#| fig-cap: Germes retrouvés

st <- paste0("N = ", length(na.omit(tt$germe)))

lollipph(tt,germe, titre = paste0("Germes retrouvés - ", st))
```


### Efficacité de la prise en charge

```{r}
#| label: tbl-effic
#| tbl-cap: Efficacité de la prise en charge


tt |>
  dplyr::select(pac_efficace) |>
  tbl_summary(
    missing = "no",
    statistic = stt,
    value = list(pac_efficace = "Oui")
  ) |>
  add_n() |>
  add_ci() |>
      add_stat_label(
    location = "column"
  ) |>
  bold_labels() |>
  modify_header(label ~ " ") |>
  pexptabph(exp = expx, nomfich = classeur, nomsheet = "effic", lg = TRUE)
```

La prise en charge a été jugée efficace pour `r aftrans(tt$pac_efficace)` (Pourcentage avec son intervalle de confiance à 95 %).



```{r}
#| label: fig-test
#| fig-cap: test p-value
#| eval: false
library(ggpubr)

patients |>## Recodage de tt$ta en tt$ta_rec
tt$ta_rec <- cut(tt$ta,
  include.lowest = TRUE,
  right = FALSE,
  dig.lab = 4,
  breaks = c(0, 60, 80, 100, 120, 200)
)
  drop_na(igs2, admission) |>
  ggplot() +
  aes(x = admission, y = igs2, fill = admission) +
  geom_boxplot() +
  geom_jitter(aes(col = admission), width = 0.2, alpha = 0.9) +
  theme_pubclean() +
  geom_pwc(p.adjust.method = "holm", ref.group = "smur")
```

# Analyse factorielle

On réalise une analyse en composante principale pour tenter de mieux décrire la population & de définir des groupes homogènes de patients. Les variables numériques ont été discréditées.

```{r}
#| label: mca-prepa

zz <- tt |> 
  dplyr::select(-c(id, fc, grossesse,traitement_propose,specialite,germe_identifie,microbio_dispo,si_autre_spe,exam_comp,germe )) |> 
  dplyr::select(!starts_with("si_")) |> 
  remove_constant(na.rm = TRUE) |> 
  mutate(ta = cut(ta,
  include.lowest = TRUE,
  right = FALSE,
  dig.lab = 4,
  breaks = c(0, 80, 100, 120, 200), 
  labels = (c("PAm < 80",  "PAm 80-100", "PAm 100-120", "PAm > 120")
))) |> 
  ## Recodage de tt$temperature en tt$temperature_rec
mutate(temperature = cut(temperature,
  include.lowest = TRUE,
  right = FALSE,
  dig.lab = 4,
  breaks = c(0, 36, 37, 38,  50),
  labels = c("<36°", "36-37°", "37-38°", "> 38°")
)) |> 
   mutate_if(is.character, as.factor) 

nn <- 1
zz <- imputeMCA(zz, ncp = nn)
zz <- as.data.frame(zz$completeObs)
rtt <- MCA(zz, graph = FALSE)
```

```{r}
#| label: fig-variance
#| fig-cap: Qualité des résultats

fviz_screeplot(rtt, addlabels = TRUE, 
               hjust = 0.4,
               geom = "bar",
               ylim = c(0, 20),
               ncp = 12,
               title = "Variance par axe")
```

La variance expliquée par les deux premiers axes n'est que de `r round(rtt$eig[2,3], 1)` %. Les résultats suivants sont donc à prendre avec précaution. L'analyse des dimensions 3 & 4 n'a pas montré de résultats pertinents.

## Variables

```{r}
#| label: fig-var1
#| fig-cap: Variables
#| fig-asp: .8

fviz_mca_var(rtt, axes = c(1,2),col.var = "contrib", repel = TRUE,
             select.var = list(contrib = 20)) +
  labs(title = "Variables") +
  theme_light() 
```

L'axe 1 (abscisse) présente une orientation bénin/grave avec en particulier les groupes masculin, fébrile, traitement long. La prise en charge conforme aux recommandation semble plus liée au cas féminin, apyrétiques, cystites simples.


## Individus

```{r}
#| label: fig-indsexe
#| fig-cap: Répartion des individus selon le sexe
#| fig-asp: .8

fviz_mca_ind(rtt, habillage = "sexe", repel = TRUE,
             geom = "point", addEllipse = TRUE) +
  labs(title = "Répartition des individus selon le sexe") +
  theme_light()
```



```{r}
#| label: fig-indtemp
#| fig-cap: Répartion des individus selon la température
#| fig-asp: .8

fviz_mca_ind(rtt, habillage = "temperature", repel = TRUE,
             geom = "point", addEllipse = TRUE) +
  labs(title = "Répartition des individus selon la température") +
  theme_light()
```

Le sexe semble être la variable la plus discriminante.

## Classification

```{r}
#| label: fig-kmean
#| fig-cap: Classification des individus
#| #| fig-asp: .8

zzc <- zz |> 
  mutate_if(is.factor, as.numeric)
# 2. Compute k-means
set.seed(123)
km.res <- kmeans(scale(zzc), 3, nstart = 25)
# 3. Visualize
fviz_cluster(km.res, data = zzc,
             ggtheme = theme_minimal(),
             main = "Classification non supervisée des individus"
             )
```

```{r}
#| label: fig-dend
#| fig-cap: Classification des individus
#| #| fig-asp: .8
#| eval: false
res <- hcut(zzc, k = 3, stand = TRUE)
# Visualize
fviz_dend(res, rect = TRUE, cex = 0.5)
```

On retrouve trois classes : Féminin, masculin & cas graves sur l'âge, les antécédents etc.

# Technique

## Statistiques
*Paragraphe statistique à copier en fin de Matériel & Méthodes.*

e \gls{alpha} retenu sera de 0,05 & la \gls{puissance} de 0,8. Les analyses ont été réalisées avec le logiciel \textsc{r} version 4.3.0 (R Core Team, 2025).

Vu le faible nombre de cas aucune hypothèse de normalité n' apu être faite. Les variables numériques sont présentées par leur médiane avec les quartiles & comparées grâce au test non paramétrique de \textsc{\gls{wilcox}}. Les variables discrètes sont présentées en nombre avec le pourcentage. Le test du $\chi^2$ sera utilisé sous réserve d'un effectif suffisant, à défaut le test exact de \textsc{\gls{fisher}}.


### Taille de l'échantillon

IL s'agit d'une étude purement descriptive sans test statistique. Il n'y a donc pas de calcul précis possible de taille d'échantillon nécessaire. Cependant, on peut estimer une taille correcte. En prenant le pire cas c'est à dire une proportion de \qty{50}{\percent} pour l'objectif principal & avec une erreur acceptable de \qty{10}{\percent}, on obtient une taille d'échantillon de \num{106} cas nécessaires dans l'échantillon.


### Qualité de l'échantillon


UN décompte des données manquantes sera réalisé. Les variables comportant trop de données manquantes ou non utilisables n'ont pas prises en compte après validation par le promoteur.

Une recherche de corrélation anormale entre les variables a été réalisée.

### Description de la population

Un tableau descriptif présentant les données démographiques de la population sera présenté.

### Objectif principal

L'adéquation de la prise en charge est définie par le promoteur pour chaque cas . Le résultat sera présenté par le nombre de cas avec le pourcentage de la population totale & son intervalle de confiance (calcul après transformation angulaire). Une recherche de facteurs pouvant influer l'adéquation de la prise en charge sera tout d'abord réalisée par une analyse univariée portant sur toutes les variables décrivant la population. Les variables significatives  p-value < \num{0.2}) sont ensuite incluses dans un modèle de régression logistique pour rechercher des facteurs indépendants. Une recherche du meilleur modèle sera réalisée par step-by-step descendant.


### Objectifs secondaires

Tous les objectifs secondaire sont présentés de la même manière :  le nombre de cas corrects avec le pourcentage & son intervalle de confiance à \qty{95}{\percent}.


### Analyse factorielle

Une description de la population par analyse en composante multiple (MCA) a été réalisée après imputation des données manquantes. L'analyse présentée n'a porté que sur les deux premières dimensions, les dimensions 3 & 4 n'apportant pas de résultat intéressant. Une classification non supervisée (méthode des k-means, trois classes, cinquante itérations maximum) a été réalisée sur les individus. Les variables numériques ont été discrétisées pour cette analyse.
